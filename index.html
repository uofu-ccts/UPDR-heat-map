</p>

<div
  id="map-container"
  style="display: flex; justify-content: center; align-items: center; position: relative;"
></div>

<div
  id="tooltip"
  class="tooltip"
  style="
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 5px;
    display: none;
  "
></div>

<p>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <br />

  <script>
    if (typeof d3 !== "undefined") {
      const mapContainer = d3.select("#map-container");

      const projection = d3.geoMercator();
      const path = d3.geoPath().projection(projection);
      const tooltip = d3.select("#tooltip");

      const mapWidth = 800;
      const mapHeight = 800;
      const legendWidth = 100;
      const legendHeight = 300;

      const testSvg = mapContainer
        .append("svg")
        .attr("width", mapWidth + legendWidth)
        .attr("height", mapHeight);

      const mapUrl =
        "https://nodered-etl.ctsi.utah.edu/api/v1/updr/map";
      const dataUrl =
        "https://nodered-etl.ctsi.utah.edu/api/v1/updr/counties";

      Promise.all([d3.json(mapUrl), d3.json(dataUrl)]).then(
        ([map, countyData]) => {
          projection.fitSize([mapWidth, mapHeight], map);

          const pdData = {};
          countyData.counties.forEach((county) => {
            pdData[county.name] = {
              count: +county.count,
              obfuscation: county.obfuscation === "true",
            };
          });

          const maxPopulation = d3.max(
            Object.values(pdData),
            (d) => d.count
          );

          const colorScale = d3
            .scaleSequential(d3.interpolateBlues)
            .domain([0, maxPopulation]);

          testSvg
            .selectAll(".county")
            .data(map.features)
            .enter()
            .append("path")
            .attr("class", "county")
            .attr("d", path)
            .attr("fill", (d) => {
              const countyName = d.properties.name;
              const county = pdData[countyName];
              const population = county ? county.count : 0;
              return colorScale(population);
            })
            .attr("stroke", "#ddd")
            .attr("stroke-width", 0.5)
            .on("mouseover", (event, d) => {
              const countyName = d.properties.name;
              const county = pdData[countyName];

              if (county) {
                const populationText = county.obfuscation
                  ? "< 11"
                  : county.count;

                tooltip
                  .style("display", "block")
                  .html(
                    `<strong>${countyName}</strong><br>
                     Population: ${populationText}`
                  );
              }
            })
            .on("mousemove", (event) => {
              tooltip
                .style("left", event.pageX - 50 + "px")
                .style("top", event.pageY - 20 + "px");
            })
            .on("mouseout", () => {
              tooltip.style("display", "none");
            });

          /* Legend */
          const legendSvg = testSvg
            .append("g")
            .attr(
              "transform",
              `translate(${mapWidth + 10}, ${
                mapHeight / 2 - legendHeight / 2
              })`
            );

          const gradient = legendSvg
            .append("defs")
            .append("linearGradient")
            .attr("id", "legend-gradient")
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "0%")
            .attr("y2", "100%");

          gradient
            .append("stop")
            .attr("offset", "0%")
            .attr("stop-color", d3.interpolateBlues(1));

          gradient
            .append("stop")
            .attr("offset", "100%")
            .attr("stop-color", d3.interpolateBlues(0));

          legendSvg
            .append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 20)
            .attr("height", legendHeight)
            .style("fill", "url(#legend-gradient)");

          const legendScale = d3
            .scaleLinear()
            .domain([maxPopulation, 0])
            .range([0, legendHeight]);

          const legendAxis = d3
            .axisRight(legendScale)
            .ticks(5)
            .tickFormat((d) => (d < 11 ? "< 11" : d));

          legendSvg
            .append("g")
            .attr("transform", "translate(20, 0)")
            .call(legendAxis);
        }
      );
    } else {
      console.error("D3.js library is not loaded.");
    }
  </script>
</p>

<p
  style="display: flex; justify-content: center; align-items: center;"
>
  Parkinsonâ€™s disease distribution by county in Utah
</p>

<p>
